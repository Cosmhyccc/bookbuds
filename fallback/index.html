<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BookBuds</title>

    <!-- App Store Smart App Banner -->
    <meta name="apple-itunes-app" content="app-id=6755941845" />

    <style>
      body {
        font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 48px 18px;
        background: #FCE4B1;
        color: #000;
      }
      .card {
        max-width: 560px;
        margin: 0 auto;
        padding: 28px 22px;
        border-radius: 18px;
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      }
      h1 { margin: 0 0 10px; font-size: 28px; }
      p { margin: 0 0 18px; line-height: 1.4; font-size: 18px; }
      a.button, button.button {
        display: inline-block;
        padding: 14px 22px;
        background: #000;
        color: #fff;
        text-decoration: none;
        border-radius: 999px;
        font-weight: 700;
        border: none;
        margin: 6px;
      }
      a.button.secondary, button.button.secondary {
        background: #22c55e;
        color: #08110a;
      }
      .small { margin-top: 14px; font-size: 13px; opacity: 0.75; }
      code {
        background: rgba(0,0,0,0.12);
        padding: 2px 7px;
        border-radius: 8px;
      }
      .row { margin-top: 10px; }
      .hidden { display:none !important; }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>üìö BookBuds</h1>

      <p id="headline">Opening BookBuds‚Ä¶</p>

      <div class="row">
        <a
          id="storeBtn"
          class="button"
          href="https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845"
          rel="noopener"
        >
          Get BookBuds
        </a>

        <a
          id="openBtn"
          class="button secondary hidden"
          href="#"
        >
          Open BookBuds
        </a>

        <button
          id="copyBtn"
          class="button secondary hidden"
          type="button"
        >
          Copy Link
        </button>
      </div>

      <div class="small" id="subcopy"></div>
    </div>

    <script>
      /**********************
       * CONFIG (your exact values)
       **********************/
      const APP_STORE_URL =
        "https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845";

      const SUPABASE_URL =
        "https://efgdhxrfiilbtzziscpf.supabase.co";

      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZ2RoeHJmaWlsYnR6emlzY3BmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDY2NTUsImV4cCI6MjA4MDAyMjY1NX0.716EywiFrmyYVKaoZXNgQ_LCn2DAKpVG3UhINqP6xh0";

      /**********************
       * Elements
       **********************/
      const headline = document.getElementById("headline");
      const subcopy = document.getElementById("subcopy");
      const storeBtn = document.getElementById("storeBtn");
      const openBtn = document.getElementById("openBtn");
      const copyBtn = document.getElementById("copyBtn");

      storeBtn.href = APP_STORE_URL;

      /**********************
       * Detect environment
       **********************/
      const ua = navigator.userAgent || "";
      const isIOS = /iPhone|iPad|iPod/i.test(ua);
      const isAndroid = /Android/i.test(ua);

      /**********************
       * Utilities
       **********************/
      function getReferrerId() {
        const params = new URLSearchParams(window.location.search);
        return params.get("referrer_user_id");
      }

      function generateToken() {
        if (crypto.randomUUID) return crypto.randomUUID();
        const arr = new Uint8Array(16);
        crypto.getRandomValues(arr);
        return Array.from(arr).map(b => b.toString(16).padStart(2,"0")).join("");
      }

      async function saveReferralClaim(referrerId, token) {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/referral_claims`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            Prefer: "return=minimal"
          },
          body: JSON.stringify({
            token_value: token,
            referrer_id: referrerId
          })
        });

        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`Supabase insert failed (${res.status}): ${txt}`);
        }
      }

      function parseRouteAndId() {
        // Examples:
        // /profile/abc123
        // /bonfire/xyz789
        const path = window.location.pathname.replace(/\/+$/, "");
        const parts = path.split("/").filter(Boolean);
        const route = parts[0] || "";
        const id = parts[1] || "";
        return { route, id };
      }

      function show(el) { el.classList.remove("hidden"); }
      function hide(el) { el.classList.add("hidden"); }

      /**********************
       * DESKTOP / NON-iOS: Keep it simple (NO tokens, NO referral copy)
       **********************/
      function desktopMode() {
        headline.textContent = "Open this link on your iPhone to join in BookBuds.";
        subcopy.textContent = "This page is just the iOS handoff. Desktop won‚Äôt open the app.";
        show(copyBtn);
        hide(openBtn);

        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            copyBtn.textContent = "Copied ‚úÖ";
            setTimeout(() => (copyBtn.textContent = "Copy Link"), 1200);
          } catch {
            copyBtn.textContent = "Copy failed";
            setTimeout(() => (copyBtn.textContent = "Copy Link"), 1200);
          }
        };
      }

      /**********************
       * iOS: Try to open app, otherwise prepare deterministic install token flow
       **********************/
      async function iosMode() {
        const { route, id } = parseRouteAndId();
        const referrerId = getReferrerId();

        // 1) If app is installed, Universal Links should open it before we even render fallback.
        // But if we still ended up here, try custom scheme once.
        // If your app supports these routes, this opens instantly for installed users.
        const qs = referrerId ? `?referrer_user_id=${encodeURIComponent(referrerId)}` : "";
        const deepLink = id
          ? `bookbuds://${encodeURIComponent(route)}/${encodeURIComponent(id)}${qs}`
          : `bookbuds://${encodeURIComponent(route || "home")}${qs}`;

        const start = Date.now();
        window.location.href = deepLink;

        // 2) If app didn't open quickly, we assume not installed ‚Üí show install UI
        setTimeout(async () => {
          // still here ‚Üí likely not installed
          if (Date.now() - start < 1700) {
            headline.innerHTML = "1) Tap <b>Get BookBuds</b> to install.<br>2) Come back here and tap <b>Open BookBuds</b>.";
            subcopy.textContent = "";

            // Only do token flow when this is actually a referral link
            if (!referrerId) {
              // No referrer ‚Üí just let App Store do its thing
              // Optionally auto-redirect to App Store after a brief pause:
              // setTimeout(() => { window.location.href = APP_STORE_URL; }, 700);
              return;
            }

            // Create deterministic token and show Open button
            const token = generateToken();
            const claimUrl = `${location.origin}/claim?token=${encodeURIComponent(token)}`;

            try {
              await saveReferralClaim(referrerId, token);
            } catch (e) {
              // If this fails, don't confuse the user‚Äîjust send them to the store.
              subcopy.textContent = "Install link setup failed. Taking you to the App Store‚Ä¶";
              setTimeout(() => { window.location.href = APP_STORE_URL; }, 800);
              return;
            }

            openBtn.href = claimUrl;
            show(openBtn);

            // NO weird ‚Äúreferral preserved‚Äù text. Just a clean instruction.
            subcopy.innerHTML = "After you install, return to this page and tap <b>Open BookBuds</b>.";
          }
        }, 900);
      }

      /**********************
       * Start
       **********************/
      (function init() {
        if (!isIOS) {
          desktopMode();
          return;
        }
        iosMode();
      })();
    </script>
  </body>
</html>
