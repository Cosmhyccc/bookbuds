<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BookBuds</title>

    <!-- App Store Smart App Banner -->
    <meta name="apple-itunes-app" content="app-id=6755941845" />

    <style>
      body {
        font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 48px 18px;
        background: #FCE4B1;
        color: #000;
      }
      .card {
        max-width: 520px;
        margin: 0 auto;
        padding: 28px 22px;
        border-radius: 18px;
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      }
      h1 { margin: 0 0 10px; font-size: 26px; }
      p { margin: 0 0 18px; line-height: 1.4; }
      a.button {
        display: inline-block;
        padding: 14px 22px;
        background: #000;
        color: #fff;
        text-decoration: none;
        border-radius: 999px;
        font-weight: 600;
        margin: 6px;
      }
      .secondary {
        background: #22c55e;
        color: #08110a;
      }
      .small { margin-top: 14px; font-size: 13px; opacity: 0.75; }
      code {
        background: rgba(0,0,0,0.1);
        padding: 2px 6px;
        border-radius: 6px;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>ðŸ“š BookBuds</h1>
      <p id="copy">Opening in the appâ€¦</p>

      <a
        id="storeBtn"
        class="button"
        href="https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845"
      >
        Get BookBuds
      </a>

      <a
        id="openBtn"
        class="button secondary"
        href="#"
        style="display:none;"
      >
        Open BookBuds
      </a>

      <div class="small" id="hint"></div>
    </div>

    <script>
      /**********************
       * CONFIG (your real values)
       **********************/
      const APP_STORE_URL =
        "https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845";

      const SUPABASE_URL =
        "https://efgdhxrfiilbtzziscpf.supabase.co";

      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZ2RoeHJmaWlsYnR6emlzY3BmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDY2NTUsImV4cCI6MjA4MDAyMjY1NX0.716EywiFrmyYVKaoZXNgQ_LCn2DAKpVG3UhINqP6xh0";

      /**********************
       * Helpers
       **********************/
      const copyEl = document.getElementById("copy");
      const hintEl = document.getElementById("hint");
      const openBtn = document.getElementById("openBtn");

      function getReferrerId() {
        const params = new URLSearchParams(window.location.search);
        return params.get("referrer_user_id");
      }

      function generateToken() {
        if (crypto.randomUUID) return crypto.randomUUID();
        const arr = new Uint8Array(16);
        crypto.getRandomValues(arr);
        return Array.from(arr).map(b => b.toString(16).padStart(2,"0")).join("");
      }

      async function saveReferralClaim(referrerId, token) {
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/referral_claims`,
          {
            method: "POST",
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              "Content-Type": "application/json",
              Prefer: "return=minimal"
            },
            body: JSON.stringify({
              token_value: token,
              referrer_id: referrerId
            })
          }
        );

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt);
        }
      }

      /**********************
       * Main
       **********************/
      (async function () {
        const referrerId = getReferrerId();

        if (!referrerId) {
          copyEl.textContent = "Get the app to start reading with friends.";
          return;
        }

        copyEl.textContent = "Preparing your inviteâ€¦";

        const token = generateToken();
        const claimUrl = `${location.origin}/claim?token=${encodeURIComponent(token)}`;

        try {
          await saveReferralClaim(referrerId, token);
        } catch (e) {
          copyEl.textContent = "Something went wrong. Please refresh.";
          hintEl.textContent = String(e.message || e);
          return;
        }

        openBtn.href = claimUrl;
        openBtn.style.display = "inline-block";

        copyEl.innerHTML =
          "1) Tap <b>Get BookBuds</b> to install.<br>" +
          "2) Come back here and tap <b>Open BookBuds</b>.";

        hintEl.innerHTML =
          "Your referral is preserved via <code>?token=â€¦</code>";
      })();
    </script>
  </body>
</html>
