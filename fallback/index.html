<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BookBuds</title>

    <meta name="apple-itunes-app" content="app-id=6755941845" />

    <style>
      body {
        font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 48px 18px;
        background: #FCE4B1;
        color: #000;
      }
      .card {
        max-width: 560px;
        margin: 0 auto;
        padding: 28px 22px;
        border-radius: 18px;
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      }
      h1 { margin: 0 0 10px; font-size: 26px; }
      p { margin: 0 0 18px; line-height: 1.4; font-size: 18px; }
      a.button {
        display: inline-block;
        padding: 14px 22px;
        background: #000;
        color: #fff;
        text-decoration: none;
        border-radius: 999px;
        font-weight: 700;
        margin: 6px;
      }
      a.button.secondary {
        background: #22c55e;
        color: #08110a;
      }
      .small { margin-top: 14px; font-size: 13px; opacity: 0.75; }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>üìö BookBuds</h1>
      <p id="copy">Install BookBuds to continue.</p>

      <a
        id="storeBtn"
        class="button"
        href="https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845"
        rel="noopener"
      >
        Get BookBuds
      </a>

      <a
        id="openBtn"
        class="button secondary"
        href="#"
        style="display:none;"
      >
        Open BookBuds
      </a>

      <div class="small" id="subcopy"></div>
    </div>

    <script>
      const APP_STORE_URL =
        "https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845";
      const SUPABASE_URL =
        "https://efgdhxrfiilbtzziscpf.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZ2RoeHJmaWlsYnR6emlzY3BmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDY2NTUsImV4cCI6MjA4MDAyMjY1NX0.716EywiFrmyYVKaoZXNgQ_LCn2DAKpVG3UhINqP6xh0";

      const copyEl = document.getElementById("copy");
      const subcopyEl = document.getElementById("subcopy");
      const openBtn = document.getElementById("openBtn");
      document.getElementById("storeBtn").href = APP_STORE_URL;

      function getReferrerId() {
        const params = new URLSearchParams(window.location.search);
        return params.get("referrer_user_id");
      }

      function generateToken() {
        return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
      }

      async function saveReferralClaim(referrerId, token) {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/referral_claims`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            Prefer: "return=minimal"
          },
          body: JSON.stringify({ token_value: token, referrer_id: referrerId })
        });
        if (!res.ok) throw new Error(await res.text().catch(() => ""));
      }

      (async function init() {
        const referrerId = getReferrerId();

        // Non-referral links: keep it dead simple
        if (!referrerId) {
          subcopyEl.textContent = "After installing, tap the invite link again from Messages.";
          return;
        }

        // Referral link: create deterministic token + show "Open BookBuds" (HTTPS)
        const token = generateToken();
        const claimUrl = `${location.origin}/claim?token=${encodeURIComponent(token)}`;

        try {
          await saveReferralClaim(referrerId, token);
        } catch {
          // If insert fails, don't confuse the user‚Äîjust let them install.
          subcopyEl.textContent = "After installing, tap the invite link again from Messages.";
          return;
        }

        // The natural user flow:
        // Install -> tap invite again (Messages) OR tap Open here (if they come back)
        openBtn.href = claimUrl;
        openBtn.style.display = "inline-block";
        copyEl.textContent = "Install BookBuds, then open the invite again to join.";
        subcopyEl.textContent = "If you just installed and came back here, tap ‚ÄúOpen BookBuds‚Äù.";
      })();
    </script>
  </body>
</html>
