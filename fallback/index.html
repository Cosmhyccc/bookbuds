<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BookBuds</title>

    <!-- Smart App Banner -->
    <meta name="apple-itunes-app" content="app-id=6755941845" />

    <style>
      body {
        font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        text-align: center;
        padding: 48px 18px;
        background: #FCE4B1;
        color: #000;
      }
      .card {
        max-width: 560px;
        margin: 0 auto;
        padding: 28px 22px;
        border-radius: 18px;
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(6px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      }
      h1 { margin: 0 0 12px; font-size: 26px; }
      p { margin: 0 0 18px; font-size: 18px; line-height: 1.4; }

      a.button {
        display: inline-block;
        padding: 14px 22px;
        background: #000;
        color: #fff;
        text-decoration: none;
        border-radius: 999px;
        font-weight: 700;
        margin: 6px;
      }
      a.button.secondary {
        background: #22c55e;
        color: #08110a;
      }

      .small {
        margin-top: 14px;
        font-size: 13px;
        opacity: 0.75;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>ðŸ“š BookBuds</h1>
      <p id="headline">Opening BookBudsâ€¦</p>

      <a
        id="storeBtn"
        class="button"
        href="https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845"
      >
        Get BookBuds
      </a>

      <a
        id="openBtn"
        class="button secondary"
        href="#"
        style="display:none;"
      >
        Open BookBuds
      </a>

      <div class="small" id="subcopy"></div>
    </div>

    <script>
      /********************
       * CONFIG
       ********************/
      const APP_STORE_URL =
        "https://apps.apple.com/us/app/bookbuds-read-with-friends/id6755941845";

      const SUPABASE_URL =
        "https://efgdhxrfiilbtzziscpf.supabase.co";

      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZ2RoeHJmaWlsYnR6emlzY3BmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDY2NTUsImV4cCI6MjA4MDAyMjY1NX0.716EywiFrmyYVKaoZXNgQ_LCn2DAKpVG3UhINqP6xh0";

      /********************
       * ELEMENTS
       ********************/
      const headline = document.getElementById("headline");
      const subcopy = document.getElementById("subcopy");
      const openBtn = document.getElementById("openBtn");
      const storeBtn = document.getElementById("storeBtn");

      storeBtn.href = APP_STORE_URL;

      /********************
       * HELPERS
       ********************/
      function getReferrerId() {
        return new URLSearchParams(window.location.search)
          .get("referrer_user_id");
      }

      function generateToken() {
        return crypto.randomUUID
          ? crypto.randomUUID()
          : Date.now() + "-" + Math.random().toString(16).slice(2);
      }

      async function saveReferralClaim(referrerId, token) {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/referral_claims`, {
          method: "POST",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            "Content-Type": "application/json",
            Prefer: "return=minimal"
          },
          body: JSON.stringify({
            token_value: token,
            referrer_id: referrerId
          })
        });

        if (!res.ok) throw new Error("Supabase insert failed");
      }

      /********************
       * MAIN FLOW
       ********************/
      (async function init() {
        const referrerId = getReferrerId();

        // No referral â†’ just send to App Store
        if (!referrerId) {
          headline.textContent = "Redirecting to the App Storeâ€¦";
          setTimeout(() => {
            window.location.href = APP_STORE_URL;
          }, 400);
          return;
        }

        // Referral flow
        const token = generateToken();
        const claimUrl = `${location.origin}/claim?token=${encodeURIComponent(token)}`;

        try {
          await saveReferralClaim(referrerId, token);
        } catch {
          // Even if referral fails, do NOT block install
          setTimeout(() => {
            window.location.href = APP_STORE_URL;
          }, 400);
          return;
        }

        // Auto-redirect to App Store (clean UX)
        headline.textContent = "Redirecting to the App Storeâ€¦";
        setTimeout(() => {
          window.location.href = APP_STORE_URL;
        }, 500);

        // Safety net ONLY (hidden at first)
        openBtn.href = claimUrl;
        subcopy.textContent =
          "If you return here after installing, tap Open BookBuds.";

        setTimeout(() => {
          openBtn.style.display = "inline-block";
        }, 2500);
      })();
    </script>
  </body>
</html>
